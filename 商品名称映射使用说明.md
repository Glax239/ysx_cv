# 商品名称映射使用说明

## 概述

本系统提供了商品名称映射功能，允许您将模型输出的类别标号（如 `product_36`）替换为自定义的商品名称（如 `可口可乐`），无需重新训练模型。

## 功能特点

- ✅ **无需重训练**: 直接映射模型输出的类别ID到自定义名称
- ✅ **支持所有模型**: 商品检测、区域检测、品牌检测、文本检测
- ✅ **动态加载**: 修改映射文件后立即生效
- ✅ **保留原始信息**: 同时保存原始类别名称和映射后名称
- ✅ **批量管理**: 提供命令行工具进行批量操作

## 文件结构

```
cv_test/
├── product_name_mapping.json    # 名称映射配置文件
├── manage_product_names.py       # 名称映射管理工具
├── utils/
│   └── name_mapper.py           # 名称映射核心模块
└── 商品名称映射使用说明.md        # 本说明文档
```

## 配置文件格式

`product_name_mapping.json` 文件格式如下：

```json
{
  "product_detector": {
    "0": "可口可乐",
    "1": "百事可乐",
    "2": "雪碧",
    "36": "自定义商品36"
  },
  "brand_detector": {
    "0": "可口可乐品牌",
    "1": "百事品牌"
  },
  "region_detector": {
    "0": "条形码区域",
    "1": "营养成分表"
  },
  "text_detector": {
    "0": "文本区域"
  }
}
```

### 配置说明

- **模型名称**: `product_detector`, `brand_detector`, `region_detector`, `text_detector`
- **类别ID**: 模型输出的数字ID（字符串格式）
- **自定义名称**: 您希望显示的商品名称

## 使用方法

### 方法一：直接编辑配置文件

1. 打开 `product_name_mapping.json` 文件
2. 在对应模型下添加或修改映射关系
3. 保存文件
4. 重新运行检测程序

### 方法二：使用管理工具

#### 查看当前映射

```bash
# 查看所有映射
python manage_product_names.py list

# 查看指定模型的映射
python manage_product_names.py list -m product_detector
```

#### 添加单个映射

```bash
# 添加商品映射
python manage_product_names.py add product_detector 0 "可口可乐"

# 添加品牌映射
python manage_product_names.py add brand_detector 0 "可口可乐品牌"
```

#### 批量添加映射

```bash
# 进入批量添加模式
python manage_product_names.py batch product_detector
```

然后按提示输入：
```
请输入映射 (类别ID,自定义名称): 0,可口可乐
请输入映射 (类别ID,自定义名称): 1,百事可乐
请输入映射 (类别ID,自定义名称): done
```

#### 删除映射

```bash
python manage_product_names.py remove product_detector 0
```

#### 导入/导出映射

```bash
# 导出所有映射到文件
python manage_product_names.py export my_mappings.json

# 导出指定模型的映射
python manage_product_names.py export product_mappings.json -m product_detector

# 从文件导入映射
python manage_product_names.py import my_mappings.json
```

## 实际应用示例

### 场景：超市商品识别

假设您的模型训练时使用了以下类别：
- `product_0`: 训练数据中的第一个商品
- `product_1`: 训练数据中的第二个商品
- `product_36`: 训练数据中的第37个商品

您可以将它们映射为实际的商品名称：

```bash
# 添加映射
python manage_product_names.py add product_detector 0 "可口可乐 330ml"
python manage_product_names.py add product_detector 1 "百事可乐 330ml"
python manage_product_names.py add product_detector 36 "雪碧 330ml"
```

### 场景：品牌识别

```bash
# 添加品牌映射
python manage_product_names.py add brand_detector 0 "Coca-Cola"
python manage_product_names.py add brand_detector 1 "Pepsi"
python manage_product_names.py add brand_detector 2 "Sprite"
```

### 场景：区域检测

```bash
# 添加区域映射
python manage_product_names.py add region_detector 0 "商品条形码"
python manage_product_names.py add region_detector 1 "营养成分表"
python manage_product_names.py add region_detector 2 "生产日期"
python manage_product_names.py add region_detector 3 "保质期信息"
```

## 检测结果变化

### 使用映射前

```json
{
  "class_id": 36,
  "class_name": "product_36",
  "confidence": 0.85,
  "bbox": [100, 100, 200, 200]
}
```

### 使用映射后

```json
{
  "class_id": 36,
  "class_name": "雪碧 330ml",
  "original_class_name": "product_36",
  "confidence": 0.85,
  "bbox": [100, 100, 200, 200]
}
```

## 注意事项

1. **类别ID对应**: 确保映射的类别ID与模型实际输出的ID一致
2. **文件编码**: 配置文件使用UTF-8编码，支持中文字符
3. **实时生效**: 修改映射文件后，下次检测时自动生效
4. **备份配置**: 建议定期备份映射配置文件
5. **原始信息保留**: 系统会保留原始类别名称，便于调试

## 高级功能

### 条件映射

您可以根据不同场景使用不同的映射配置：

```python
# 在代码中动态切换映射文件
from utils.name_mapper import ProductNameMapper

# 使用不同的映射文件
supermarket_mapper = ProductNameMapper('supermarket_mappings.json')
convenience_store_mapper = ProductNameMapper('convenience_store_mappings.json')
```

### 映射验证

```python
# 验证映射配置
mapper = ProductNameMapper()
all_mappings = mapper.get_all_mappings()

for model_name, mappings in all_mappings.items():
    print(f"{model_name}: {len(mappings)} 个映射")
```

## 故障排除

### 常见问题

1. **映射不生效**
   - 检查配置文件格式是否正确
   - 确认类别ID是否匹配
   - 查看日志输出

2. **中文显示乱码**
   - 确保配置文件使用UTF-8编码
   - 检查系统字体支持

3. **配置文件损坏**
   - 使用JSON验证工具检查格式
   - 从备份恢复配置文件

### 调试方法

```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 查看映射过程
from utils.name_mapper import get_global_mapper
mapper = get_global_mapper()
result = mapper.map_class_name('product_detector', 36, 'product_36')
print(f"映射结果: {result}")
```

## 总结

通过名称映射功能，您可以：

1. **提升用户体验**: 显示有意义的商品名称而非技术标号
2. **灵活配置**: 根据不同应用场景调整显示名称
3. **快速部署**: 无需重新训练模型即可更新商品信息
4. **便于维护**: 集中管理所有商品名称映射

这个功能特别适合以下场景：
- 零售商品识别系统
- 库存管理应用
- 智能购物助手
- 商品分析工具

如有任何问题，请参考日志输出或联系技术支持。