# 智能商品识别与健康分析系统

![Logo](assets/logo/logo.png)

## 1. 项目简介

**智能商品识别与健康分析系统** 是一个先进的计算机视觉项目，旨在通过图像识别技术，自动检测、识别收银台小票或购物场景中的多种商品，并结合营养学知识，为用户提供个性化的健康分析报告。

本系统利用深度学习模型（YOLOv5）对图像中的商品进行高精度定位和识别，支持自定义商品种类和品牌。通过一个用户友好的图形界面（PyQt5），用户可以轻松上传图片，系统将自动完成识别、分析，并生成详细的报告。此外，系统还支持命令行模式，方便集成和批量处理。

该项目解决了传统图像识别中中文标签显示乱码的问题，并提供了灵活的配置文件，方便用户根据自身需求进行调整。

## 2. 核心功能

- **高精度商品识别**: 基于YOLOv5模型，能准确识别多种预定义的商品和品牌。
- **中文标签支持**: 优化了图像标注功能，完美支持在结果图片上渲染中文标签。
- **健康分析报告**: （概念功能）可根据识别出的商品，分析其营养成分，并提供健康建议。
- **用户友好图形界面**: 提供基于PyQt5的GUI，支持图片上传、实时识别、结果展示和报告导出。
- **灵活的配置**:
    - `config.py`: 集中管理所有路径、模型参数和程序行为。
    - `product_name_mapping.json`: 允许用户自定义商品识别标签到实际商品名称的映射。
- **多种输出格式**:
    - **图像**: 在原始图片上绘制带有中文标签的识别框。
    - **JSON**: 包含每个识别物体的详细信息（坐标、置信度、类别）。
    - **CSV/TXT**: 简洁的文本格式，方便数据分析和记录。
- **命令行支持**: `detect.py` 脚本支持通过命令行参数直接进行图像识别，便于自动化和脚本集成。
- **日志记录**: 完整的日志系统，记录程序运行状态和错误，便于调试。

## 3. 项目架构

项目采用模块化设计，主要分为以下几个部分：

- **`core` (核心逻辑模块)**:
    - `simple_detection_engine.py`: 封装了YOLOv5模型的加载、预处理和推理过程，是商品识别的核心引擎。
    - `image_processor.py`: 图像处理工具，负责图像的读取、绘制和保存。
    - `gemini_health_analyzer.py`: （概念模块）用于与外部API（如Gemini）交互，进行健康分析。
    - `simple_information_extractor.py`: 从识别结果中提取关键信息。

- **`gui` (图形用户界面模块)**:
    - `pyqt5_main_window.py`: 定义了应用的主窗口、控件布局和事件处理。

- **`utils` (工具模块)**:
    - `font_utils.py`: 提供了在图像上绘制中文文本的核心功能，解决了OpenCV的局限性。
    - `logger.py`: 配置和管理日志记录器。
    - `file_utils.py`: 文件和目录操作的辅助函数。
    - `name_mapper.py`: 加载和管理 `product_name_mapping.json` 中的商品名称映射。

- **`config` (配置模块)**:
    - `config.py`: 全局配置文件。

- **`weight` (模型权重)**:
    - 存放 `.pt` 格式的YOLOv5模型权重文件。

- **`assets` (资源文件)**:
    - `icons`: 存放应用的ICO和PNG图标。
    - `logo`: 存放项目Logo。

- **`output` (输出目录)**:
    - 存放所有识别结果，按下属子目录分类（`csv_results`, `json_results`, `reports`, `text_results`）。

## 4. 技术栈

- **编程语言**: Python 3.9+
- **核心框架**:
    - **PyTorch**: 用于加载和运行深度学习模型。
    - **YOLOv5**: 作为核心的目标检测算法。
    - **OpenCV-Python**: 用于基础的图像处理。
    - **Pillow (PIL)**: 用于在图像上渲染中文字体。
    - **PyQt5**: 用于构建图形用户界面。
- **主要依赖库**: `numpy`, `pandas`, `pyyaml`

## 5. 安装与设置

**第一步：克隆或下载项目**

```bash
git clone <your-repository-url>
cd cv_test
```

**第二步：创建虚拟环境（推荐）**

为了避免包版本冲突，建议在虚拟环境中安装。

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
.\venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

**第三步：安装依赖**

项目的所有依赖都记录在 `requirements.txt` 文件中。

```bash
pip install -r requirements.txt
```

**第四步：检查配置文件**

- **`config.py`**: 打开此文件，确保 `BASE_DIR` 路径正确。通常情况下，它会自动设置为当前项目根目录，无需修改。检查其他路径（如模型、输出目录）是否符合你的需求。
- **`product_name_mapping.json`**: 此文件定义了模型识别出的标签（如 `coke`）与你希望展示的中文名称（如 `可口可乐`）之间的映射。你可以根据自己的模型和需求进行修改。

## 6. 如何使用

### 6.1 图形用户界面 (GUI)

这是最推荐的使用方式。

**启动GUI:**

```bash
python start_pyqt5_gui.py
```

**界面操作:**

1.  **加载图片**: 点击 "加载图片" 按钮，选择一张需要识别的图片。
2.  **开始识别**: 点击 "开始识别" 按钮，系统将调用模型进行分析。
3.  **查看结果**:
    - **图像显示区**: 左侧将显示标注了识别框和中文标签的结果图片。
    - **信息输出区**: 右侧的文本框将显示详细的识别结果（JSON格式）。
4.  **保存结果**: 点击 "保存结果" 按钮，系统会将本次识别的**标注图片**、**JSON文件**和**TXT文件**保存到 `output` 目录下，并按时间戳命名。
5.  **清空**: 点击 "清空" 按钮，可以清除当前图片和结果，进行下一次识别。

### 6.2 命令行模式

如果你需要进行批量处理或集成到其他脚本中，可以使用 `detect.py`。

**基本用法:**

```bash
python detect.py --source <image_path>
```

**参数说明:**

- `--source`: **必需参数**。指定要识别的图片路径。
- `--weights`: 指定模型权重文件路径。默认为 `config.py` 中配置的 `BEST_PT_PATH`。
- `--conf`: 置信度阈值。默认为0.25。
- `--img-size`: 图像缩放尺寸。默认为640。
- `--device`: 指定运行设备（如 `cpu`, `0` for GPU 0）。默认为空，自动选择。
- `--name`: 指定输出结果的保存目录名，位于 `output/` 下。默认为 `exp`。
- `--no-save`: 添加此参数后，将不保存结果图片和标签文件。

**示例:**

```bash
# 识别单张图片并保存结果
python detect.py --source "coke.jpg"

# 使用不同的置信度阈值，并且不保存结果
python detect.py --source "oreo.jpg" --conf 0.5 --no-save
```

## 7. 常见问题 (FAQ)

**Q1: 识别结果中标注的中文显示为问号或乱码。**
**A1:** 此问题已通过引入 `Pillow` 库解决。请确保：
1.  `utils/font_utils.py` 文件存在且代码正确。
2.  `core/simple_detection_engine.py` 和 `detect.py` 已正确调用 `draw_chinese_text_on_image` 函数。
3.  系统中存在可用的中文字体（`config.py` 中的 `FONT_PATH` 指向一个有效的 `.ttf` 或 `.otf` 字体文件，如 `C:/Windows/Fonts/msyh.ttc`）。

**Q2: 程序启动时报错 `FileNotFoundError`，找不到模型文件或配置文件。**
**A2:** 这是路径问题。请检查 `config.py` 中的路径配置是否正确，特别是 `BASE_DIR` 和模型权重文件的路径。确保所有路径都是相对于 `BASE_DIR` 的正确相对路径。

**Q3: 如何添加或修改我自己的商品识别类别？**
**A3:** 这需要两步：
1.  **重新训练模型**: 你需要使用标注了新类别的数据集来重新训练或微调你的YOLOv5模型，生成一个新的 `.pt` 权重文件。
2.  **更新名称映射**: 在 `product_name_mapping.json` 文件中，添加新的类别标签和对应的中文名称。例如，如果你的新类别是 `pepsi`，可以添加 `"pepsi": "百事可乐"`。

**Q4: GUI界面卡住或无响应。**
**A4:** 如果正在处理一张非常大的图片或者模型较大，识别过程可能会花费一些时间。请耐心等待。如果长时间无响应，请检查命令行的日志输出，看是否有错误信息。

## 8. 未来工作

- [ ] **性能优化**: 对图像预处理和模型推理进行优化，提升识别速度。
- [ ] **视频支持**: 扩展功能以支持实时视频流的商品识别。
- [ ] **健康分析模块完善**: 对接真实的营养数据库API，提供更科学、更详细的健康报告。
- [ ] **模型管理**: 在GUI中添加模型切换功能，方便用户使用不同的模型。

## 9. 许可证

本项目采用 [MIT License](LICENSE) 开源。

## 10. 致谢

- 本项目基于 [YOLOv5](https://github.com/ultralytics/yolov5) 模型架构。
- 感谢所有为相关开源库做出贡献的开发者。
